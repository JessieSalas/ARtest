<!DOCTYPE html>
<html>
<head>
    <title>AR Data Visualization</title>
    <meta charset="UTF-8">
    <!-- Ensuring proper scaling on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- A-Frame and AR.js libraries -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
        }
        #control-container { 
            position: fixed; 
            bottom: 10px; 
            width: 100%; 
            text-align: center; 
            padding: 5px; 
            background: rgba(255,255,255,0.6); 
            z-index: 999;  /* ensures the controls are above other elements */
        }
        .control { 
            margin: 5px; 
        }
    </style>
</head>
<body>

<a-scene embedded arjs='sourceType: webcam;'>
    <a-assets>
        <img id="d3-image" crossorigin="anonymous">
    </a-assets>
    <a-marker preset="hiro">
        <a-plane position="0 0 0" rotation="-90 0 0" width="1" height="1" material="src: #d3-image;"></a-plane>
    </a-marker>
    <a-entity camera></a-entity>
</a-scene>

<div id="control-container">
    <!-- Control elements for various properties -->
    <select id="colorSelector" class="control">
        <option value="green">Green</option>
        <option value="red">Red</option>
        <option value="blue">Blue</option>
    </select>

    <select id="sizeSelector" class="control">
        <option value="small">Small</option>
        <option value="medium">Medium</option>
        <option value="large">Large</option>
    </select>

    <select id="numberSelector" class="control">
        <option value="1">One Circle</option>
        <option value="2">Two Circles</option>
        <option value="3">Three Circles</option>
    </select>
</div>

<iframe id="d3-iframe" style="display:none;" src="visualization.html"></iframe>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const iframe = document.getElementById('d3-iframe');

        // Function to handle control change
        function handleControlChange() {
            const message = {
                type: 'updateVisualization',
                color: document.getElementById('colorSelector').value,
                size: document.getElementById('sizeSelector').value,
                number: document.getElementById('numberSelector').value
            };
            iframe.contentWindow.postMessage(message, '*');
        }

        // Attaching event listeners to each control
        document.querySelectorAll('.control').forEach((control) => {
            control.addEventListener('change', handleControlChange);
            
            // Prevent touch event interference with AR view
            control.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            }, { passive: false }); // ensures that the event listener doesn't neglect preventDefault
        });

        // Listen for messages from the iframe
        window.addEventListener('message', function(event) {
            if (event.data.type === 'render') {
                const img = document.getElementById('d3-image');
                img.setAttribute('src', event.data.dataUrl); // Use setAttribute for elements within a-scene
            }
        });
    });
</script>

</body>
</html>
